package gr.tracer.platform.components;

import eu.sqooss.core.AlitheiaCore;
import eu.sqooss.service.db.DBService;
import eu.sqooss.service.db.StoredProject;
import eu.sqooss.service.db.User;
import eu.sqooss.service.logging.Logger;
import gr.tracer.common.entities.db.MonitoredProjectList;
import gr.tracer.common.entities.db.MonitoredProjectListProject;
import gr.tracer.common.entities.db.SecurityLibrary;
import gr.tracer.common.entities.db.SecurityProfile;

import eu.sqooss.service.security.SecurityManager;
import eu.sqooss.service.logging.Logger;
import gr.tracer.common.entities.db.ProjectFileVulnerability;
import gr.tracer.common.entities.db.VulnerabilityType;
import gr.tracer.platform.TracerPlatform;


import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

public class VulnerabilityDetectionComponentImpl implements
		VulnerabilityDetectionComponent {
	
	private TracerPlatform platform;
	private Logger logger;
	private DBService dbs;
	private Map<String, Object> monProjListProps;
	private Object lockObject = new Object();

	/*
     * Parameterless constructor of the class.
     */
	public VulnerabilityDetectionComponentImpl () {
		monProjListProps = new Hashtable<String, Object>(1);
	}
	
	/**
     * @see gr.tracer.platform.components.VulnerabilityDetectionComponent#addToDetectedVulnerabilities(java.util.List)
     */
	@Override
	public boolean addToDetectedVulnerabilities(List<ProjectFileVulnerability> sProjVul) {
		
		SecurityProfileComponent spc = platform.getComponent(SecurityProfileComponent.class);
		try {
			Iterator<ProjectFileVulnerability> it = sProjVul.iterator();
			ProjectFileVulnerability pvf;
			
			if (dbs.startDBSession()) {
				while(it.hasNext()){
					pvf = it.next();
					VulnerabilityType vt = spc.searchVulnerabilityType(pvf.getVulnerabilityType().getName());
					if (vt == null) {
						vt = spc.createVulnerabilityType(pvf.getVulnerabilityType().getName(), pvf.getVulnerabilityType().getName());
						pvf.setVulnerabilityType(vt);
					} else
						pvf.setVulnerabilityType(vt);
					dbs.addRecord(pvf);
				}
			return true;
			} else
				return false;
		} finally {
			if (dbs.isDBSessionActive())
				dbs.commitDBSession();
		}
	}
	
	/**
     * @see gr.tracer.platform.components.VulnerabilityDetectionComponent#getSecurityLibrariesTreatingVulnerabilityType(java.lang.String)
     */
	@Override
	public HashSet<SecurityLibrary> getSecurityLibrariesTreatingVulnerabilityType(
			String vtName) {
		SecurityProfileComponent spc = platform.getComponent(SecurityProfileComponent.class);
		VulnerabilityType vt = spc.searchVulnerabilityType(vtName);
		
		if (vt != null)
			return (HashSet<SecurityLibrary>) vt.getTreatingSecurityLibraries();
		else
			return null;
	}
	
	/**
     * @see gr.tracer.platform.components.VulnerabilityDetectionComponent#getVulnerabilityTypesDetectedBySecurityProfile(java.lang.String)
     */
	@Override
	public HashSet<VulnerabilityType> getVulnerabilityTypesDetectedBySecurityProfile(
			String spName) {
		
		SecurityProfileComponent spc = platform.getComponent(SecurityProfileComponent.class);
		SecurityProfile sp = spc.searchSecurityProfile(spName);
		
		if (sp != null)
			return (HashSet<VulnerabilityType>) sp.getDetectedVulnerabilityTypes();
		else
			return null;
	}
	
	/**
     * @see gr.tracer.platform.components.VulnerabilityDetectionComponent#getMonitoredProjectListBySecurityProfile(java.lang.String)
     */
	@Override
	public MonitoredProjectList getMonitoredProjectListBySecurityProfile(
			String spName) {
		
		SecurityProfileComponent spc = platform.getComponent(SecurityProfileComponent.class);
		SecurityProfile sp = spc.searchSecurityProfile(spName);
		
		List<MonitoredProjectList> mpls = null;
		try {
			if (dbs.startDBSession() && (sp != null)) {
				synchronized (lockObject) {
					monProjListProps.clear();
					monProjListProps.put("securityProfile", sp);
					mpls = dbs.findObjectsByProperties(MonitoredProjectList.class, monProjListProps);
					return (mpls.size() > 0 && mpls != null) ? mpls.get(0) : null;
				}
			} else {
				return null;
			}
		} finally {
			dbs.commitDBSession();
		}
	}
	
	/**
     * @see gr.tracer.platform.components.VulnerabilityDetectionComponent#getMonitoredProjectListByUser(java.lang.String)
     */
	@Override
	public List<MonitoredProjectList> getMonitoredProjectListByUser(String userName) {
		
		SecurityManager sm = AlitheiaCore.getInstance().getSecurityManager();
		
		User user = sm.getUserManager().getUser(userName);
		
		List<MonitoredProjectList> mpls = null;
		try {
			if (dbs.startDBSession() && (user != null)) {
				synchronized (lockObject) {
					monProjListProps.clear();
					monProjListProps.put("user", user);
					mpls = dbs.findObjectsByProperties(MonitoredProjectList.class, monProjListProps);
					return (mpls != null) ? mpls : null;
				}
			} else {
				return null;
			}
		} finally {
			dbs.commitDBSession();
		}
	}
	
	/**
     * @see gr.tracer.platform.components.VulnerabilityDetectionComponent#getStoredProjectsOfMonitoredObservedProjectList(java.lang.String)
     */
	@Override
	public HashSet<StoredProject> getStoredProjectsOfMonitoredProjectList(
			String mplName) {
		
		SecurityProfileComponent spc = platform.getComponent(SecurityProfileComponent.class);
		MonitoredProjectList mpl = spc.searchMonitoredProjectList(mplName);
		HashSet<MonitoredProjectListProject> mplps = null;
		if (mpl != null)
			mplps = (HashSet<MonitoredProjectListProject>) mpl.getProjects();
		else
			return null;
		
		HashSet<StoredProject> storProjs = new HashSet<StoredProject>();
		MonitoredProjectListProject mplp;
		Iterator<MonitoredProjectListProject> it = mplps.iterator();		
		while (it.hasNext()){
			mplp = it.next();
			storProjs.add(mplp.getProject());
		}		
		return storProjs;
	}

	@Override
	public void initComponent(TracerPlatform platform, Logger logger) {
		this.platform = platform;
		this.logger = logger;
	}

	@Override
	public boolean startUp() {
		try {
			this.dbs = AlitheiaCore.getInstance().getDBService();
			SecurityProfileComponent spc = platform.getComponent(SecurityProfileComponent.class);
			
			securityLibraryTest(spc, "SQL library name", "SQL library description");
			securityLibraryTest(spc, "XSS library name", "XSS library description");
						
			vulnerabilityTypeTest(spc, "SQL name", "SQL description");
			vulnerabilityTypeTest(spc, "XSS name", "XSS description");
			
			securityProfileTest(spc, "Security profile 1 name", "Security profile 1 description");
			securityProfileTest(spc, "Security profile 2 name", "Security profile 2 description");
			
			monitoredProjectListTest(spc, "Monitored project list 1 name", "Monitored project list 1 description", "Security profile 2 name");
			monitoredProjectListTest(spc, "Monitored project list 2 name", "Monitored project list 2 description", "Security profile 1 name");
			
			securityLibraryToVulnerabilityTypeAssociationTest(spc, "SQL library name", "SQL name");
			securityLibraryToVulnerabilityTypeAssociationTest(spc, "XSS library name", "XSS name");
			
			securityProfileMonitoredProjectListAssociationTest(spc, "Security profile 2 name", "Monitored project list 2 name");
			
			securityProfileVulnerabilityTypeAssociationTest(spc, "SQL name", "Security profile 2 name");
			securityProfileVulnerabilityTypeAssociationTest(spc, "XSS name", "Security profile 1 name");
						
			projectToMonitoredProjectListAssociationTest(spc, "Stored project 1", "Monitored project list 1 name");
			//projectToMonitoredProjectListAssociationTest(spc, "Stored project 2", "Monitored project list 1 name");
			//projectToMonitoredProjectListAssociationTest(spc, "Stored project 1", "Monitored project list 2 name");
			//projectToMonitoredProjectListAssociationTest(spc, "Stored project 2", "Monitored project list 2 name");
			
			return true;
		} catch(Exception e) {
			e.printStackTrace();
		}
		return false;
	}

	private void projectToMonitoredProjectListAssociationTest(
			SecurityProfileComponent spc, String spName, String mplName) {
		if (spc.addProjectToMonitoredProjectList(spName, mplName))
			System.out.println("Project:'" + spName + "' associated with Monitored project list:'"+ mplName +"'");
		else
			System.out.println("Project:'" + spName + "' NOT associated with Monitored project list:'"+ mplName +"'");
	}
	
	private void removeProjectToMonitoredProjectListAssociationTest(
			SecurityProfileComponent spc, String spName, String mplName) {
		if (spc.removeProjectFromMonitoredProjectList(spName, mplName))
			System.out.println("Project:'" + spName + "' removed from Monitored project list:'"+ mplName +"'");
		else
			System.out.println("Project:'" + spName + "' NOT removed from Monitored project list:'"+ mplName +"'");
	}
	
	private void securityLibraryToVulnerabilityTypeAssociationTest(
			SecurityProfileComponent spc, String libName, String vulnTypeName) {
		if (spc.addSecurityLibraryToVulnerabilityType(libName, vulnTypeName))
			System.out.println("Vulnerability type:'"+ vulnTypeName +"' associated with Security library:'"+ libName +"'");
		else
			System.out.println("Vulnerability type:'"+ vulnTypeName +"' NOT associated with Security library:'"+ libName +"'");
	}
	
	private void securityProfileMonitoredProjectListAssociationTest(
			SecurityProfileComponent spc, String spName, String mplName) {
		System.out.println("Security profile:'" + spName + "'" + 
			(spc.setSecurityProfileToList(spName, mplName) ? "' " : "' NOT ")+
			"associated with Monitored project list:'" + mplName +"'");
	}
	
	private void securityProfileVulnerabilityTypeAssociationTest(
			SecurityProfileComponent spc, String vulnTypeName, String secProfName) {
		if (spc.addVulnerabilityTypeToSecurityProfile(vulnTypeName, secProfName))
			System.out.println("Vulnerability type:'" + vulnTypeName + 
					"' associated with Security profile:'" + secProfName + "'");
		else
			System.out.println("Vulnerability type:'" + vulnTypeName + 
					"' NOT associated with Security profile:'" + secProfName + "'");
	}
	
	private void securityProfileRemoveVulnerabilityTypeAssociationTest(
			SecurityProfileComponent spc, String vulnTypeName, String secProfName) {
		if (spc.removeVulnerabilityTypeFromSecurityProfile(vulnTypeName, secProfName))
			System.out.println("Vulnerability type:'" + vulnTypeName + 
					"' removed association from Security profile:'" + secProfName + "'");
		else
			System.out.println("Vulnerability type:'" + vulnTypeName + 
					"' NOT removed association from Security profile:'" + secProfName + "'");
	}

	private void securityLibraryTest(SecurityProfileComponent spc, String name, String description) {
		if (spc.searchSecurityLibrary(name) == null) {
			if (spc.createSecurityLibrary(name, description) != null)
				System.out.println("Security library:'" + name + "' created");
			else
				System.out.println("Security library:'" + name + "' NOT created");
		}
		else
			System.out.println("Security library:'" + name + "' found");
	}

	private void vulnerabilityTypeTest(SecurityProfileComponent spc, String name, String description) {
		if (spc.searchVulnerabilityType(name) == null) {
			if (spc.createVulnerabilityType(name, description) != null)
				System.out.println("Vulnerability type:'" + name + "' created");
			else
				System.out.println("Vulnerability type:'" + name + "' NOT created");
		}
		else
			System.out.println("Vulnerability type:'" + name + "' found");
	}

	private void securityProfileTest(SecurityProfileComponent spc, String name, String desc) {
		if (spc.searchSecurityProfile(name) == null) {
			if (spc.createSecurityProfile(name, desc) != null)
				System.out.println(name + " created");
			else
				System.out.println(name + " NOT created");
		}
		else
			System.out.println(name + " found");
	}

	private void monitoredProjectListTest(SecurityProfileComponent spc, String name, String desc, String spname) {
		if (spc.searchMonitoredProjectList(name) == null) {
			if (spc.createMonitoredProjectList(name, desc, "fotis", spname) != null)
				System.out.println(name + " created");
			else
				System.out.println(name + " NOT created");
		}
		else
			System.out.println(name + " found");
	}

	@Override
	public boolean shutDown() {
		return true;
	}
}
