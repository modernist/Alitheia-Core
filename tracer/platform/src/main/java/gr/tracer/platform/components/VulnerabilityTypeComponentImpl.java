package gr.tracer.platform.components;

import java.util.Hashtable;
import java.util.List;
import java.util.Map;

import eu.sqooss.core.AlitheiaCore;
import eu.sqooss.service.db.DBService;
import eu.sqooss.service.logging.Logger;
import gr.tracer.common.entities.db.SecurityLibrary;
import gr.tracer.common.entities.db.VulnerabilityType;
import gr.tracer.platform.TracerPlatform;

public class VulnerabilityTypeComponentImpl implements VulnerabilityTypeComponent {
	
	private TracerPlatform platform;
	private Logger logger;
	private DBService dbs;
	private Map<String, Object> vulProps;
    private Object lockObject = new Object();
	
    VulnerabilityTypeComponentImpl(){
    	TracerPlatform platform = TracerPlatform.getInstance();
    	Logger logger = AlitheiaCore.getInstance().getLogManager().createLogger("Tracer");
    	initComponent(platform, logger);
    	startUp();
    }
    
	@Override
	public List<VulnerabilityType> getVulnerabilityTypeList() {
		
		StringBuilder q = new StringBuilder("from VulnerabilityType vt");
		return (List<VulnerabilityType>) dbs.doHQL(q.toString());
	}

	@Override
	public VulnerabilityType getVulnerabilityType(int vtId) {
		try {
	    	if(dbs.startDBSession()) {
	    		return dbs.findObjectById(VulnerabilityType.class, vtId);
	    	}
	    	else
	    		return null;
    	}
    	finally {
    		if(dbs.isDBSessionActive())
    			dbs.commitDBSession();
    	}
	}
	
	@Override
	public VulnerabilityType createVulnerabilityType(String vtName, String vtDescription) {
		VulnerabilityType vt = new VulnerabilityType();
		vt.setName(vtName);
		vt.setDescription(vtDescription);
		if(dbs != null && dbs.startDBSession())
    	{
    		if(dbs.addRecord(vt))
    			return dbs.commitDBSession() ? vt : null;
    	}
    	return null;
	}

	@Override
	public VulnerabilityType searchVulnerabilityType(String vtName) {
		List<VulnerabilityType> vulTypes;
		try {
			if (dbs.startDBSession()) {
				synchronized (lockObject) {
					vulProps.clear();
					vulProps.put("name", vtName);
					vulTypes = dbs.findObjectsByProperties(VulnerabilityType.class, vulProps);
					if (vulTypes.size() != 0)
						return vulTypes.get(0);
					else {
						logger.info("VulnerabilityType with this does not exist");
						return null;
					}
				}
			} else {
				return null;
			}
		} finally {
			if (dbs.isDBSessionActive())
				dbs.commitDBSession();
		}
	}
	
	@Override
	public boolean addSecurityLibraryToVulnerabilityType(String slName, String vtName) {
        try {
        	if (dbs.startDBSession()) {
        		SecurityLibraryComponent slc = new SecurityLibraryComponentImpl();
        		SecurityLibrary sl = slc.searchSecurityLibrary(slName);
        		VulnerabilityType vt = searchVulnerabilityType(vtName);
        		if ((sl!=null) && (vt != null)) {
        			return ((sl.getTreatedVulnerabilityTypes().add(vt)) &&
        					(vt.getTreatingSecurityLibraries().add(sl)));
        		} else {
        			logger.error("SecurityLibrary or VulnerabilityType do not exist");
        			return false;
        		}
        	} else {
    			return false;
        	}
        } finally {
        	if (dbs.isDBSessionActive())
				dbs.commitDBSession();
        }
    }

	@Override
	public void initComponent(TracerPlatform platform, Logger logger) {
		// TODO Auto-generated method stub
		this.platform = platform;
		this.logger = logger;
	}

	@Override
	public boolean startUp() {
		// TODO Auto-generated method stub
		this.dbs = platform.getDB();
		vulProps = new Hashtable<String, Object>(1);
		if (platform != null)
			platform.registerComponent(VulnerabilityTypeComponent.class, VulnerabilityTypeComponentImpl.class);
		return true;
	}

	@Override
	public boolean shutDown() {
		// TODO Auto-generated method stub
		return true;
	}

}
